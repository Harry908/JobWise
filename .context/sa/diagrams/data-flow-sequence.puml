@startuml Data-Flow-Sequence
!theme plain
title Resume Generation Data Flow Sequence

actor User
participant "Flutter App" as App
participant "FastAPI Backend" as Backend
participant "AI Orchestrator" as AI
participant "Job Analyzer" as Stage1
participant "Profile Compiler" as Stage2
participant "Document Generator" as Stage3
participant "Quality Validator" as Stage4
participant "PDF Exporter" as Stage5
participant "LLM Provider" as LLM
participant "Database" as DB
participant "File Storage" as Files

User -> App: Select job + master resume
activate App

App -> Backend: POST /generate/resume
activate Backend

Backend -> DB: Store generation request
Backend -> AI: Start pipeline(profile, job)
activate AI

AI -> Stage1: Analyze job description
activate Stage1
Stage1 -> LLM: Extract requirements (1500 tokens)
LLM --> Stage1: Job analysis result
Stage1 --> AI: Structured requirements
deactivate Stage1

AI -> Stage2: Compile profile relevance
activate Stage2
Stage2 -> LLM: Score profile sections (2000 tokens)
LLM --> Stage2: Relevance scores
Stage2 --> AI: Ranked profile content
deactivate Stage2

AI -> Stage3: Generate tailored content
activate Stage3
Stage3 -> LLM: Create resume content (3000 tokens)
LLM --> Stage3: Generated content
Stage3 --> AI: Tailored resume text
deactivate Stage3

AI -> Stage4: Validate quality
activate Stage4
Stage4 -> LLM: Check ATS compliance (1500 tokens)
LLM --> Stage4: Validation report
Stage4 --> AI: Quality-assured content
deactivate Stage4

AI -> Stage5: Export to PDF
activate Stage5
Stage5 -> Files: Generate PDF file
Files --> Stage5: PDF file path
Stage5 --> AI: PDF document
deactivate Stage5

AI --> Backend: Generation complete
deactivate AI

Backend -> DB: Update generation status
Backend -> Files: Store final document
Backend --> App: 202 Accepted + generation_id

App -> User: Show generation started
deactivate Backend

' Polling for status
loop Status Checking
  App -> Backend: GET /generate/status/{id}
  Backend -> DB: Check generation status
  DB --> Backend: Current status
  Backend --> App: Status response
  App -> User: Update progress
end

' Final result
App -> Backend: GET /documents/{id}/download
activate Backend
Backend -> Files: Retrieve PDF
Files --> Backend: PDF file
Backend --> App: PDF content
deactivate Backend

App -> User: Display generated resume
deactivate App

note over Stage1, Stage5
  Token Budget Management:
  Total: 8000 tokens
  Stage 1: 1500 tokens (19%)
  Stage 2: 2000 tokens (25%)
  Stage 3: 3000 tokens (37%)
  Stage 4: 1500 tokens (19%)
  Stage 5: 0 tokens (local processing)
end note

note over Backend, DB
  Error Handling:
  - LLM timeout: Return cached result
  - Token limit: Compress context & retry
  - Quality failure: Single strict retry
  - Complete failure: Return error status
end note

@enduml